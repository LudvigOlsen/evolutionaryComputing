---
title: "Analysis_of_experimental_results"
author: "Ludvig Olsen"
date: "10/9/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Attach libraries
```{r}
library(tidyverse)
library(knitr)

data_path <- "results_data/"

```

## Load data

### Condition: Increasing both

In this condition the number of migrants go up over time, while the epoch size becomes smaller (so migrations/communications become more frequent).

```{r}
data_timeseries_increasing_both <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsIncreasingMigrationBoth.txt")) %>% 
  mutate(condition = "increasing_both",
         migration_direction = "increasing") 

data_results_increasing_both <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsIncreasingMigrationBoth.txt")) %>% 
  mutate(condition = "increasing_both",
         migration_direction = "increasing")

```

### Condition: Increasing number of migrants

Increase the number of individuals that migrate after each epoch.

```{r}
data_timeseries_increasing_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsIncreasingMigrationMigrants.txt")) %>% 
  mutate(condition = "increasing_migrants",
         migration_direction = "increasing")

data_results_increasing_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsIncreasingMigrationMigrants.txt")) %>% 
  mutate(condition = "increasing_migrants",
         migration_direction = "increasing")

```

### Condition: Increasing the frequency of migrations

```{r}
data_timeseries_increasing_frequency <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsIncreasingMigrationFitness.txt")) %>% 
  mutate(condition = "increasing_frequency",
         migration_direction = "increasing")

data_results_increasing_frequency <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsIncreasingMigrationFitness.txt")) %>% 
  mutate(condition = "increasing_frequency",
         migration_direction = "increasing")

```

### Condition: Steady migration, 2 migrants

```{r}
data_timeseries_steady_migration_2_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsSteadyMigration2Migrants.txt")) %>% 
  mutate(condition = "steady_migration_2",
         migration_direction = "steady")

data_results_steady_migration_2_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsSteadyMigration2Migrants.txt")) %>% 
  mutate(condition = "steady_migration_2",
         migration_direction = "steady")


```


### Condition: Steady migration, 5 migrants

```{r}
data_timeseries_steady_migration_5_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsSteadyMigration5Migrants.txt")) %>% 
  mutate(condition = "steady_migration_5",
         migration_direction = "steady")

data_results_steady_migration_5_migrants <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsSteadyMigration5Migrants.txt")) %>% 
  mutate(condition = "steady_migration_5",
         migration_direction = "steady")


```


### Condition: No migration

```{r}
data_timeseries_no_migration <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsNoMigration.txt")) %>% 
  mutate(condition = "no_migration",
         migration_direction = "none")

data_results_no_migration <- read.csv(paste0(data_path, "KatsuuraEvaluationResultsFinalResultsNoMigration.txt")) %>% 
  mutate(condition = "no_migration",
         migration_direction = "none")


```

### Testing stuff

```{r}

data_timeseries_no_migration_test <- read.csv(
  paste0(data_path, "KatsuuraEvaluationResultsNoMigrationTestRun.txt")) %>% 
  mutate(condition = "no_migration",
         migration_direction = "none")

```



## Combine data

```{r}
data_timeseries_combined <- data_timeseries_increasing_both %>% 
  bind_rows(data_timeseries_increasing_migrants,
            data_timeseries_increasing_frequency,
            data_timeseries_steady_migration_2_migrants, 
            data_timeseries_steady_migration_5_migrants,
            data_timeseries_no_migration) %>% 
  mutate(pretty_condition_newline = str_replace_all(condition, "_", "\n"),
         pretty_condition_space = str_replace_all(condition, "_", " "))


data_results_combined <- data_results_increasing_both %>% 
  bind_rows(data_results_increasing_migrants,
            data_results_increasing_frequency,
            data_results_steady_migration_2_migrants,
            data_results_steady_migration_5_migrants,
            data_results_no_migration)%>% 
  mutate(pretty_condition_newline = str_replace_all(condition, "_", "\n"),
         pretty_condition_space = str_replace_all(condition, "_", " "))


```


## Analysis

### Timeseries 


```{r}

# Inter-island Diversity

data_timeseries_combined %>% 
  ggplot(aes(Generation, InterIsland.Diversity, color = pretty_condition_space)) +
  geom_smooth() + 
  labs(y="Inter-island diversity",title="Inter-island diversity over time") + 
  theme_bw()

# Global diversity
data_timeseries_combined %>% 
  ggplot(aes(Generation, Global.Diversity, color = pretty_condition_space)) +
  geom_smooth() + 
  labs(y="Global diversity",title="Global diversity over time\nAverage Std. of genes across all individuals") + 
  theme_bw()


# Best score so far

data_timeseries_combined %>% 
  ggplot(aes(Generation, Best.Score.So.Far, color = pretty_condition_space)) +
  geom_smooth() + 
  labs(y = "Best score so far", title="Best score over time") + 
  theme_bw()

# Number of migrants over time

data_timeseries_combined %>% 
  filter(condition == "increasing_both") %>% 
  ggplot(aes(Generation, Migrants)) +
  geom_smooth() + 
  labs(title="Number of migrants over time") + 
  theme_bw()

# Epoch sizes over time

data_timeseries_combined %>% 
  filter(condition == "increasing_both") %>% 
  ggplot(aes(Generation, Epoch.Size)) +
  geom_smooth() + 
  labs(title="Epoch size over time") + 
  theme_bw()
```

### Results

```{r}

# Box plot of results

data_results_combined %>% 
  ggplot(aes(pretty_condition_newline, Final.Score, color = migration_direction)) +
  geom_boxplot()  + 
  #geom_violin() +
  labs(x="Condition", y="Fitness") +
  theme_bw()
```

Analysis of final results:

```{r}
data_results_combined %>% 
  group_by(pretty_condition_space) %>% 
  summarise(mean_ = mean(Final.Score),
            median_ = median(Final.Score),
            sd_ = sd(Final.Score)) %>% 
  kable()

lm(Final.Score~condition, data=data_results_combined) %>% 
  summary()

```


### Testing

```{r}
# Best score so far

data_timeseries_no_migration_test %>% 
  ggplot(aes(Generation, Avg.Global.Fitness)) +
  geom_smooth() + 
  labs(y = "Global average fitness", title="The average fitness of all individuals") + 
  theme_bw()
```

Best island? Would maybe say something about initialization?
```{r}
data_best_island_no_migration_test <- data_timeseries_no_migration_test %>% 
  select(c(Run, Generation, condition, Island0, Island1, Island2, Island3, Island4)) %>% 
  gather(Island, AvgIslandFitness, 4:8) %>% 
  mutate(is_last_measurement = if_else(Generation == max(Generation), 1, 0)) %>% 
  group_by(Run, Island) %>% 
  mutate(is_max_avg_fitness = if_else(AvgIslandFitness == max(AvgIslandFitness), 1,0))
  
data_best_island_no_migration_test %>% 
  ggplot(aes(Generation, AvgIslandFitness, color=Island)) +
  geom_smooth() + 
  labs(y = "Average fitness", title="Average Fitness per Island with No Migration") + 
  theme_bw()


data_best_island_no_migration_test %>% 
  filter(is_last_measurement == 1) %>% 
  ggplot(aes(Island, AvgIslandFitness, color=condition)) +
  geom_boxplot() + 
  labs(y = "Average fitness", title="Average Fitness per Island with No Migration") + 
  theme_bw()

data_best_island_no_migration_test %>% 
  filter(is_last_measurement == 1) %>% 
  arrange(Run, desc(AvgIslandFitness)) %>% 
  group_by(Run) %>% 
  mutate(Rank = factor(1:n())) %>% 
  ggplot(aes(Rank, AvgIslandFitness, color=condition)) +
  geom_boxplot() + 
  labs(x = "Ranked Islands", y = "Final Average fitness", 
       title="Final Average Fitness per Ranked Island with No Migration") + 
  theme_bw()

data_best_island_no_migration_test %>% 
  filter(is_max_avg_fitness == 1) %>% 
  arrange(Run, desc(AvgIslandFitness)) %>% 
  group_by(Run) %>% 
  mutate(Rank = factor(1:n())) %>% 
  ggplot(aes(Rank, AvgIslandFitness, color=condition)) +
  geom_boxplot() + 
  labs(x = "Ranked Islands",y = "Max. Average fitness", 
       title="Max. Average Fitness per Ranked Island with No Migration") + 
  theme_bw()


```






